name       : ldc
version    : 1.11.0
release    : 10
source     :
    - git|https://github.com/ldc-developers/ldc.git : v1.11.0
license    :
    - BSD-3-Clause
    - BSL-1.0
    - GPL-2.0
component  : programming
summary    : The LLVM-based D Compiler
description: |
    The LDC project provides a portable D programming language compiler with modern optimization and code generation capabilities. The compiler uses the official DMD frontend to support the latest version of D2, and relies on the LLVM Core libraries for code generation.
clang      : yes
libsplit   : no
patterns   :
    - /usr/include/*
    - /usr/lib64/*
builddeps  :
    - pkgconfig(libconfig)
setup      : |
    git checkout ltsmaster
    git submodule update

    %patch -p1 < $pkgfiles/bash-completion-hack.patch

    mkdir bootstrap && pushd bootstrap
    cmake -G Ninja \
        -DBUILD_SHARED_LIBS=OFF \
        -DCMAKE_INSTALL_PREFIX=$workdir/ldc-ltsmaster \
    ..
    LC_ALL=en_US.UTF-8 ninja install %JOBS% -v
    popd
build      : |
    git reset --hard
    git checkout tags/v${version}
    git submodule update

    %cmake_ninja \
        -DCMAKE_BUILD_TYPE=Release \
        -DLIB_SUFFIX=64 \
        -DBUILD_SHARED_LIBS=ON \
        -DINCLUDE_INSTALL_DIR=/usr/include/dlang/ldc \
        -DLDC_WITH_LLD=OFF \
        -DD_COMPILER=$workdir/ldc-ltsmaster/bin/ldmd2

    %ninja_build -v
install    : |
    %ninja_install
check      : |
    # We seem to have missing symbols very similar
    # to this bug: https://github.com/NixOS/nixpkgs/issues/28896
    %ninja_check || :
